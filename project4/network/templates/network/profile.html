{% extends 'network/layout.html' %}

{% block title %}Profile{% endblock %}

{% block body %}
<script>
    let is_following;
    let profile;
    let profileUsername;    // logged in user username
    let firstVisit = true;

    // see if user is following or not
    function follow() {

        fetch(`/api/following/${currentUserID}`)
        .then(response => response.json())
        .then(following => {
            is_following = following.following;     // people that logged in user is following
            profile = document.querySelector('#username');
            profileUsername = profile.textContent;  // profile view username

            // create constants for follow buttons
            const followButton = document.querySelector('#follow_button');

            if (profileUsername == currentUsername) {
                followButton.style.display = 'none';
                return
            }

            // prevents changing following status on first visit
            if (firstVisit == true) {
                    firstVisit = false;
                    if (is_following.includes(profileUsername)) {
                        followButton.innerHTML = 'Unfollow';
                    } else {
                        followButton.innerHTML = 'Follow';
                    }
                    return  // breaks out of function
            }


            // checks if logged in user is following viewed profile
            if (is_following.includes(profileUsername)) {
                followButton.innerHTML = 'Follow';

                // removes follower
                fetch(`/api/following/${currentUserID}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        following: profileUsername,
                        action: 'remove'
                    })
                })
                .then(response => response.json())
                .then(result => {
                    console.log(result);
                })

            } else {
                // hide follow button, show unfollow button
                followButton.innerHTML = 'Unfollow';

                // adds follower
                fetch(`/api/following/${currentUserID}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        following: profileUsername,
                        action: 'add'
                    })
                })
                .then(response => response.json())
                .then(result => {
                    console.log(result);
                })
            };
        });
    };

    document.addEventListener('DOMContentLoaded', follow);

</script>

    <div id="profile-header">
        <h1 id="username">{{ user_profile.username }}</h1>
            <table id="profile-table">
                <tbody>
                    <tr>
                        <td class="profile-stats">{{ posts_count }}</td>
                        <td class="profile-stats">{{ following_count }}</td>
                        <td class="profile-stats">{{ followers_count }}</td>
                    </tr>
                    <tr>
                        <td class="profile-stats">Posts</td>
                        <td class="profile-stats">Following</td>
                        <td class="profile-stats">Followers</td>
                    </tr>
                </tbody>
            </table>
    </div>

    <div id="following">
        <p id="follow_button" onclick=follow()>Follow</p>
    </div>

    
        {% if posts %}  
        <div id="posts-container">
            {% for post in posts %}
                <div class="ind-post">
                    <p class="post-info post-content">{{ post.content }}</p>
                    <p class="post-info post-likes">❤️ {{ post.likes }}</p>
                    <p class="post-info post-date">{{ post.date }}</p>
                </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-posts">
            <h1>No Posts Yet</h1>
        </div>
        <div class="no-posts">
            <img id="no-posts-image" src="https://pbs.twimg.com/media/CidJXBuUUAEgAYu.jpg">
        </div>
        {% endif %}
{% endblock %}